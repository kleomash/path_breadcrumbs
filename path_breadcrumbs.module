<?php

/**
 * Implements hook_page_alter().
 */
function path_breadcrumbs_page_alter(&$page) {

  // See if current page has path breadcrumbs.
  $variant = path_breadcrumbs_load_variant(request_path());

  // If object with breadcrumbs was loaded - build breadcrumbs.
  if ($variant) {
    $breadcrumbs = _path_breadcrumbs_build_breadcrumbs($variant);
    drupal_set_breadcrumb($breadcrumbs);
  }
}

/**
 * Load path breadcrumb variants by path.
 */
function path_breadcrumbs_load_variant($path) {

  if (!$path) {
    return FALSE;
  }

  // Create sql pattern from url.
  $path_vars = explode('/', $path);
  if ($args_count = (sizeof($path_vars) - 1)) {
    $sql_path = array_fill(0, $args_count, '%');
    array_unshift($sql_path, $path_vars[0]);
    $sql_replacements = implode('/', $sql_path);
  }
  else {
    $sql_replacements = $path;
  }

  $variants = db_select('path_breadcrumbs', 'p')
    ->fields('p',  array('path_id', 'path'))
    ->condition('p.path', $sql_replacements, 'LIKE')
    ->orderBy('p.weight')
    ->execute();

  foreach ($variants as $variant) {
    $matched_path = array();
    $arguments    = explode('/', $variant->path);
    foreach ($arguments as $argument) {
      if ($argument[0] == '%') {
        $matched_path[] = '*';
      }
      else {
        $matched_path[] = $argument;
      }
    }
    $matched_path = implode('/', $matched_path);
    if (drupal_match_path($path, $matched_path)) {
      return path_breadcrumbs_load($variant->path_id);
    }
  }

  return FALSE;
}

/**
 * Builds array with breadcrumbs.
 */
function _path_breadcrumbs_build_breadcrumbs($path_breadcrumb) {
  $breadcrumb = array();

  // Add HOME link.
  if ($path_breadcrumb->home == TRUE) {
    $breadcrumb[] = l(t('Home'), '<front>');
  }

  if (!empty($path_breadcrumb->arguments)) {

    // Include ctools library for contexts.
    ctools_include('context');
    $contexts = array();

    // Get contexts from arguments.
    foreach ($path_breadcrumb->arguments as $keyword => $arg) {
      if (!empty($arg['argument'])) {
        $argument = ctools_get_argument($arg['argument']);
        if (isset($arg['settings'])) {
          $argument = array_merge($argument, $arg['settings']);
        }
        $context  = call_user_func($argument['context'], arg($arg['position']), $argument);
        $context->keyword = $keyword;
        $contexts[] = $context;
      }
    }

    // Replace placeholders by current values.
    $path_breadcrumb->titles = ctools_context_keyword_substitute($path_breadcrumb->titles, array(), $contexts);
    $path_breadcrumb->paths  = ctools_context_keyword_substitute($path_breadcrumb->paths, array(), $contexts);
  }

  $titles = explode("\n", $path_breadcrumb->titles);
  $paths  = explode("\n", $path_breadcrumb->paths);

  foreach ($titles as $key => $title) {

    // Translate breadcrumb title if needed.
    if ($path_breadcrumb->translatable == TRUE) {
      $title = t($title);
    }

    // Set a breadcrumb as a link or as a plain text.
    if (isset($paths[$key]) && $paths[$key] != '<none>') {
      $breadcrumb[] = l(check_plain($title), $paths[$key]);
    }
    elseif (isset($paths[$key]) && $paths[$key] == '<none>') {
      $breadcrumb[] = check_plain($title);
    }
  }

  return $breadcrumb;
}

/**
 * Save path breadcrumbs.
 */
function path_breadcrumbs_save($breadcrumb) {

  // Remove spaces and empty lines in breadcrumb titles.
  $titles_output = array();
  $titles = explode("\r\n", $breadcrumb->titles);
  foreach ($titles as $title) {
    if ($trimmed_title = trim($title)) {
      $titles_output[] = $trimmed_title;
    }
  }

  // Remove spaces and empty lines in breadcrumb titles.
  $paths_output = array();
  $paths = explode("\r\n", $breadcrumb->paths);
  foreach ($paths as $path) {
    if ($trimmed_path = trim($path)) {
      $paths_output[] = $trimmed_path;
    }
  }

  // Build data to be inserted in database.
  $insert_data = array(
    'name'         => $breadcrumb->name,
    'machine_name' => $breadcrumb->machine_name,
    'path'         => $breadcrumb->path,
    'data'         => serialize(array(
      'titles'        => implode("\r\n", $titles_output),
      'paths'         => implode("\r\n", $paths_output),
      'home'          => $breadcrumb->home,
      'translatable'  => $breadcrumb->translatable,
      'arguments'     => $breadcrumb->arguments,
    )),
  );

  if (!empty($breadcrumb->path_id)) {
    // Update path breadcrumbs.
    db_update('path_breadcrumbs')
      ->fields($insert_data)
      ->condition('path_id', $breadcrumb->path_id)
      ->execute();
  }
  else {
    // Create new path breadcrumbs.
    $path_id = db_insert('path_breadcrumbs')
      ->fields($insert_data)
      ->execute();
  }

  return isset($path_id) ? $path_id : $breadcrumb->path_id;
}

/**
 * Delete path breadcrumbs.
 */
function path_breadcrumbs_delete($path_breadcrumb) {

  if (ctype_digit($path_breadcrumb)) {
    $path_id = $path_breadcrumb;
  }
  elseif (is_object($path_breadcrumb)) {
    $path_id = $path_breadcrumb->path_id;
  }
  else {
    return FALSE;
  }

  // Delete path breadcrumbs from database.
  $result = db_delete('path_breadcrumbs')
    ->condition('path_id', $path_id)
    ->execute();

  return $result;
}

/**
 * Load path breadcrumbs.
 */
function path_breadcrumbs_load($path_id) {
  static $paths;

  if (!isset($paths[$path_id])) {
    $breadcrumb = db_select('path_breadcrumbs', 'p')
      ->fields('p')
      ->condition('p.path_id', $path_id)
      ->execute()
      ->fetchObject();

    if ($breadcrumb) {
      $breadcrumb->data = unserialize($breadcrumb->data);
      $breadcrumb = (object) array_merge((array) $breadcrumb, $breadcrumb->data);
      unset($breadcrumb->data);
    }
    $paths[$path_id] = $breadcrumb;
  }

  return $paths[$path_id];
}

/**
 * Load path breadcrumb by machine name.
 */
function path_breadcrumbs_load_by_name($name) {
  static $paths;

  if (!isset($paths[$name])) {
    $breadcrumb = db_select('path_breadcrumbs', 'p')
      ->fields('p')
      ->condition('p.machine_name', $name)
      ->execute()
      ->fetchObject();

    if ($breadcrumb) {
      $breadcrumb->data = unserialize($breadcrumb->data);
      $breadcrumb = (object) array_merge((array) $breadcrumb, $breadcrumb->data);
      unset($breadcrumb->data);
    }
    $paths[$name] = $breadcrumb;
  }

  return $paths[$name];
}

/**
 * Return ctools object cache data.
 */
function path_breadcrumbs_object_cache_get($name, $skip_cache = FALSE) {
  ctools_include('object-cache');
  return ctools_object_cache_get('path_breadcrumbs', $name, $skip_cache);
}

/**
 * Save data to ctools object cache storage.
 */
function path_breadcrumbs_object_cache_set($name, $data) {
  ctools_include('object-cache');
  $data = (object) $data;
  ctools_object_cache_set('path_breadcrumbs', $name, $data);
}
